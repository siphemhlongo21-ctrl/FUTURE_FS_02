<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mini CRM ‚Äî Lead Management</title>
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,300&display=swap" rel="stylesheet"/>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #0a0a0f; --surface: #111118; --surface2: #1a1a24; --border: #2a2a3a;
      --accent: #6c63ff; --accent2: #ff6b6b; --accent3: #43e97b;
      --text: #e8e8f0; --text-muted: #6b6b80;
      --new: #6c63ff; --contacted: #f7a51e; --converted: #43e97b;
    }
    body { background: var(--bg); color: var(--text); font-family: 'DM Sans', sans-serif; min-height: 100vh; overflow-x: hidden; }
    body::before { content: ''; position: fixed; inset: 0; background-image: linear-gradient(rgba(108,99,255,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(108,99,255,0.03) 1px, transparent 1px); background-size: 40px 40px; pointer-events: none; z-index: 0; }
    @keyframes slideUp { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* LOGIN */
    #loginPage { position: fixed; inset: 0; z-index: 9999; display: flex; align-items: center; justify-content: center; background: var(--bg); }
    .login-card { background: var(--surface); border: 1px solid var(--border); border-radius: 24px; padding: 48px 40px; width: 100%; max-width: 420px; position: relative; animation: slideUp 0.4s ease; }
    .login-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, var(--accent), #a78bfa); border-radius: 24px 24px 0 0; }
    .login-logo { text-align: center; margin-bottom: 32px; }
    .login-logo .icon { font-size: 48px; display: block; margin-bottom: 12px; }
    .login-logo h1 { font-family: 'Syne', sans-serif; font-size: 28px; font-weight: 800; }
    .login-logo h1 span { color: var(--accent); }
    .login-logo p { color: var(--text-muted); font-size: 14px; margin-top: 4px; }
    .form-label { display: block; font-size: 12px; font-weight: 600; letter-spacing: 0.5px; color: var(--text-muted); margin-bottom: 8px; text-transform: uppercase; }
    .form-group { margin-bottom: 16px; }
    .form-input, .form-select, .form-textarea { width: 100%; background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; padding: 12px 14px; color: var(--text); font-size: 14px; font-family: 'DM Sans', sans-serif; outline: none; transition: border-color 0.2s; }
    .form-input:focus, .form-select:focus, .form-textarea:focus { border-color: var(--accent); }
    .form-textarea { resize: vertical; min-height: 90px; }
    .login-btn { width: 100%; padding: 14px; background: var(--accent); color: white; border: none; border-radius: 10px; font-size: 15px; font-weight: 600; font-family: 'DM Sans', sans-serif; cursor: pointer; transition: all 0.2s; margin-top: 8px; }
    .login-btn:hover { background: #5a52e0; transform: translateY(-1px); box-shadow: 0 8px 20px rgba(108,99,255,0.3); }
    .default-creds { background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; padding: 14px 16px; margin-top: 20px; }
    .default-creds p { font-size: 11px; color: var(--text-muted); margin-bottom: 6px; font-weight: 600; letter-spacing: 0.5px; text-transform: uppercase; }
    .default-creds span { font-size: 13px; color: var(--text); display: block; margin-top: 4px; }
    .default-creds span strong { color: var(--accent); }
    .login-error { color: var(--accent2); font-size: 13px; margin-top: 10px; text-align: center; display: none; }

    /* SIDEBAR */
    .sidebar { position: fixed; top: 0; left: 0; width: 240px; height: 100vh; background: var(--surface); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 32px 20px; z-index: 100; }
    .logo { display: flex; align-items: center; gap: 10px; margin-bottom: 48px; }
    .logo-icon { width: 36px; height: 36px; background: var(--accent); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px; }
    .logo-text { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 18px; letter-spacing: -0.5px; }
    .logo-text span { color: var(--accent); }
    .nav-label { font-size: 10px; font-weight: 500; letter-spacing: 2px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 12px; padding-left: 12px; }
    .nav-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; color: var(--text-muted); transition: all 0.2s; margin-bottom: 4px; }
    .nav-item.active, .nav-item:hover { background: rgba(108,99,255,0.12); color: var(--text); }
    .nav-item.active { color: var(--accent); }
    .nav-item .icon { font-size: 16px; width: 20px; text-align: center; }
    .sidebar-footer { margin-top: auto; padding-top: 20px; border-top: 1px solid var(--border); }
    .admin-badge { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 8px; background: var(--surface2); }
    .admin-avatar { width: 32px; height: 32px; background: linear-gradient(135deg, var(--accent), var(--accent2)); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: 700; }
    .admin-info { flex: 1; }
    .admin-name { font-size: 13px; font-weight: 500; }
    .admin-role { font-size: 11px; color: var(--text-muted); }
    .logout-btn { width: 100%; margin-top: 10px; padding: 10px; background: rgba(255,107,107,0.1); border: 1px solid rgba(255,107,107,0.2); color: var(--accent2); border-radius: 8px; font-size: 13px; font-weight: 600; font-family: 'DM Sans', sans-serif; cursor: pointer; transition: all 0.2s; }
    .logout-btn:hover { background: rgba(255,107,107,0.2); }

    /* MAIN */
    .main { margin-left: 240px; padding: 40px; position: relative; z-index: 1; }
    .page { display: none; }
    .page.active { display: block; animation: slideUp 0.3s ease; }

    /* HEADER */
    .header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 40px; }
    .header-title { font-family: 'Syne', sans-serif; font-size: 32px; font-weight: 800; letter-spacing: -1px; line-height: 1; }
    .header-title span { background: linear-gradient(135deg, var(--accent), #a78bfa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .header-sub { font-size: 14px; color: var(--text-muted); margin-top: 6px; }

    /* BUTTONS */
    .btn { display: inline-flex; align-items: center; gap: 8px; padding: 12px 20px; border-radius: 10px; font-size: 14px; font-weight: 500; font-family: 'DM Sans', sans-serif; cursor: pointer; border: none; transition: all 0.2s; }
    .btn-primary { background: var(--accent); color: white; }
    .btn-primary:hover { background: #5a52e0; transform: translateY(-1px); box-shadow: 0 8px 20px rgba(108,99,255,0.3); }
    .btn-ghost { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
    .btn-ghost:hover { background: var(--border); }

    /* STATS */
    .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 32px; }
    .stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: 14px; padding: 20px; position: relative; overflow: hidden; transition: transform 0.2s; }
    .stat-card:hover { transform: translateY(-2px); }
    .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; }
    .stat-card:nth-child(1)::before { background: var(--accent); }
    .stat-card:nth-child(2)::before { background: var(--new); }
    .stat-card:nth-child(3)::before { background: var(--contacted); }
    .stat-card:nth-child(4)::before { background: var(--converted); }
    .stat-label { font-size: 12px; color: var(--text-muted); letter-spacing: 0.5px; margin-bottom: 10px; }
    .stat-value { font-family: 'Syne', sans-serif; font-size: 36px; font-weight: 800; line-height: 1; }
    .stat-icon { position: absolute; top: 20px; right: 20px; font-size: 24px; opacity: 0.4; }

    /* TOOLBAR */
    .toolbar { display: flex; gap: 12px; margin-bottom: 24px; align-items: center; }
    .search-box { flex: 1; position: relative; }
    .search-box input { width: 100%; background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 11px 16px 11px 40px; color: var(--text); font-size: 14px; font-family: 'DM Sans', sans-serif; outline: none; transition: border-color 0.2s; }
    .search-box input:focus { border-color: var(--accent); }
    .search-box input::placeholder { color: var(--text-muted); }
    .search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--text-muted); }
    .filter-select { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 11px 16px; color: var(--text); font-size: 14px; font-family: 'DM Sans', sans-serif; outline: none; cursor: pointer; }

    /* TABLE */
    .table-wrapper { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; overflow: hidden; }
    table { width: 100%; border-collapse: collapse; }
    thead { background: var(--surface2); border-bottom: 1px solid var(--border); }
    th { padding: 14px 20px; text-align: left; font-size: 11px; font-weight: 600; letter-spacing: 1.5px; text-transform: uppercase; color: var(--text-muted); }
    td { padding: 16px 20px; font-size: 14px; border-bottom: 1px solid rgba(42,42,58,0.5); vertical-align: middle; }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: rgba(108,99,255,0.04); }
    .lead-name { font-weight: 500; }
    .lead-email { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
    .source-badge { display: inline-flex; align-items: center; gap: 5px; padding: 4px 10px; border-radius: 20px; font-size: 12px; background: var(--surface2); border: 1px solid var(--border); color: var(--text-muted); }
    .status-badge { display: inline-flex; align-items: center; gap: 5px; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
    .status-new { background: rgba(108,99,255,0.15); color: #9b94ff; border: 1px solid rgba(108,99,255,0.3); }
    .status-contacted { background: rgba(247,165,30,0.15); color: #f7a51e; border: 1px solid rgba(247,165,30,0.3); }
    .status-converted { background: rgba(67,233,123,0.15); color: #43e97b; border: 1px solid rgba(67,233,123,0.3); }
    .status-dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; }
    .actions { display: flex; gap: 8px; }
    .action-btn { padding: 6px 12px; border-radius: 7px; font-size: 12px; font-weight: 500; font-family: 'DM Sans', sans-serif; cursor: pointer; border: none; transition: all 0.2s; }
    .action-edit { background: rgba(108,99,255,0.15); color: #9b94ff; }
    .action-edit:hover { background: rgba(108,99,255,0.25); }
    .action-delete { background: rgba(255,107,107,0.1); color: var(--accent2); }
    .action-delete:hover { background: rgba(255,107,107,0.2); }
    .empty-state { text-align: center; padding: 80px 20px; color: var(--text-muted); }
    .empty-icon { font-size: 48px; margin-bottom: 16px; opacity: 0.4; }
    .empty-title { font-family: 'Syne', sans-serif; font-size: 20px; font-weight: 700; color: var(--text); margin-bottom: 8px; }
    .loading { text-align: center; padding: 60px; color: var(--text-muted); }
    .spinner { width: 32px; height: 32px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 16px; }

    /* ANALYTICS */
    .analytics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 24px; }
    .chart-card { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; padding: 24px; }
    .chart-title { font-family: 'Syne', sans-serif; font-size: 16px; font-weight: 700; margin-bottom: 20px; }
    .chart-title span { color: var(--accent); }
    .bar-chart { display: flex; flex-direction: column; gap: 14px; }
    .bar-row { display: flex; align-items: center; gap: 12px; }
    .bar-label { font-size: 13px; color: var(--text-muted); width: 90px; text-align: right; }
    .bar-track { flex: 1; height: 28px; background: var(--surface2); border-radius: 6px; overflow: hidden; }
    .bar-fill { height: 100%; border-radius: 6px; display: flex; align-items: center; padding-left: 10px; font-size: 12px; font-weight: 600; transition: width 1s ease; min-width: 30px; }
    .bar-new { background: linear-gradient(90deg, rgba(108,99,255,0.6), rgba(108,99,255,0.3)); color: #9b94ff; }
    .bar-contacted { background: linear-gradient(90deg, rgba(247,165,30,0.6), rgba(247,165,30,0.3)); color: #f7a51e; }
    .bar-converted { background: linear-gradient(90deg, rgba(67,233,123,0.6), rgba(67,233,123,0.3)); color: #43e97b; }
    .donut-wrap { display: flex; align-items: center; gap: 24px; }
    .donut-legend { display: flex; flex-direction: column; gap: 12px; }
    .legend-item { display: flex; align-items: center; gap: 8px; font-size: 13px; }
    .legend-dot { width: 10px; height: 10px; border-radius: 50%; }
    .insight-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px; margin-bottom: 24px; }
    .insight-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 18px; text-align: center; }
    .insight-value { font-family: 'Syne', sans-serif; font-size: 28px; font-weight: 800; color: var(--accent); }
    .insight-label { font-size: 12px; color: var(--text-muted); margin-top: 4px; }
    .source-row { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(42,42,58,0.5); font-size: 13px; }
    .source-row:last-child { border-bottom: none; }

    /* FOLLOW UPS */
    .followup-list { display: flex; flex-direction: column; gap: 14px; }
    .followup-card { background: var(--surface); border: 1px solid var(--border); border-radius: 14px; padding: 20px; display: flex; align-items: center; gap: 16px; transition: transform 0.2s; }
    .followup-card:hover { transform: translateY(-2px); }
    .followup-card.overdue { border-left: 3px solid var(--accent2); }
    .followup-card.today { border-left: 3px solid var(--contacted); }
    .followup-card.upcoming { border-left: 3px solid var(--accent); }
    .followup-card.done { opacity: 0.5; }
    .followup-avatar { width: 44px; height: 44px; border-radius: 12px; background: linear-gradient(135deg, var(--accent), #a78bfa); display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: 700; flex-shrink: 0; }
    .followup-info { flex: 1; }
    .followup-name { font-weight: 600; font-size: 15px; }
    .followup-note { font-size: 13px; color: var(--text-muted); margin-top: 3px; }
    .followup-date { font-size: 12px; font-weight: 600; padding: 4px 10px; border-radius: 20px; white-space: nowrap; }
    .date-overdue { background: rgba(255,107,107,0.15); color: var(--accent2); }
    .date-today { background: rgba(247,165,30,0.15); color: #f7a51e; }
    .date-upcoming { background: rgba(108,99,255,0.15); color: #9b94ff; }
    .followup-actions { display: flex; gap: 8px; }
    .filter-tabs { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
    .filter-tab { padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 500; cursor: pointer; border: 1px solid var(--border); background: var(--surface); color: var(--text-muted); transition: all 0.2s; }
    .filter-tab.active { background: var(--accent); color: white; border-color: var(--accent); }

    /* SETTINGS */
    .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .settings-card { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; padding: 24px; }
    .settings-section-title { font-family: 'Syne', sans-serif; font-size: 16px; font-weight: 700; margin-bottom: 20px; }
    .settings-row { display: flex; align-items: center; justify-content: space-between; padding: 14px 0; border-bottom: 1px solid rgba(42,42,58,0.5); }
    .settings-row:last-child { border-bottom: none; }
    .settings-label { font-size: 14px; font-weight: 500; }
    .settings-desc { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
    .toggle { position: relative; width: 44px; height: 24px; flex-shrink: 0; }
    .toggle input { opacity: 0; width: 0; height: 0; }
    .toggle-slider { position: absolute; inset: 0; background: var(--border); border-radius: 24px; cursor: pointer; transition: 0.3s; }
    .toggle-slider::before { content: ''; position: absolute; height: 18px; width: 18px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: 0.3s; }
    .toggle input:checked + .toggle-slider { background: var(--accent); }
    .toggle input:checked + .toggle-slider::before { transform: translateX(20px); }
    .settings-input { background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 8px 12px; color: var(--text); font-size: 13px; font-family: 'DM Sans', sans-serif; outline: none; width: 100px; }
    .profile-section { display: flex; align-items: center; gap: 16px; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border); }
    .profile-avatar-big { width: 64px; height: 64px; background: linear-gradient(135deg, var(--accent), var(--accent2)); border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 28px; font-weight: 700; flex-shrink: 0; }
    .save-btn { margin-top: 20px; width: 100%; padding: 12px; background: var(--accent); color: white; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; font-family: 'DM Sans', sans-serif; cursor: pointer; transition: all 0.2s; }
    .save-btn:hover { background: #5a52e0; }

    /* MODAL */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); z-index: 1000; display: none; align-items: center; justify-content: center; }
    .modal-overlay.open { display: flex; }
    .modal { background: var(--surface); border: 1px solid var(--border); border-radius: 20px; padding: 32px; width: 100%; max-width: 480px; position: relative; animation: slideUp 0.3s ease; max-height: 90vh; overflow-y: auto; }
    .modal-title { font-family: 'Syne', sans-serif; font-size: 22px; font-weight: 800; margin-bottom: 24px; }
    .modal-actions { display: flex; gap: 10px; margin-top: 24px; }
    .modal-close { position: absolute; top: 16px; right: 16px; background: var(--surface2); border: 1px solid var(--border); color: var(--text-muted); width: 32px; height: 32px; border-radius: 8px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
    .modal-close:hover { background: var(--border); color: var(--text); }

    /* NOTIFICATION */
    .notification { position: fixed; bottom: 24px; right: 24px; background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 14px 20px; font-size: 14px; font-weight: 500; z-index: 9999; transform: translateY(100px); opacity: 0; transition: all 0.3s ease; }
    .notification.show { transform: translateY(0); opacity: 1; }
    .notification.success { border-left: 3px solid var(--converted); }
    .notification.error { border-left: 3px solid var(--accent2); }

    @media (max-width: 900px) {
      .sidebar { display: none; } .main { margin-left: 0; padding: 20px; }
      .stats, .analytics-grid, .settings-grid, .insight-grid { grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>
<body>

<!-- LOGIN -->
<div id="loginPage">
  <div class="login-card">
    <div class="login-logo">
      <span class="icon">üìä</span>
      <h1>Mini<span>CRM</span></h1>
      <p>Client Lead Management System</p>
    </div>
    <div class="form-group">
      <label class="form-label">Username</label>
      <input type="text" class="form-input" id="loginUser" placeholder="Enter username" value="admin"/>
    </div>
    <div class="form-group">
      <label class="form-label">Password</label>
      <input type="password" class="form-input" id="loginPass" placeholder="Enter password" value="admin123"/>
    </div>
    <button class="login-btn" onclick="doLogin()">Sign In ‚Üí</button>
    <div class="login-error" id="loginError">‚ùå Invalid username or password</div>
    <div class="default-creds">
      <p>üîë Default Login Credentials</p>
      <span>Username: <strong>admin</strong></span>
      <span>Password: <strong>admin123</strong></span>
    </div>
  </div>
</div>

<!-- SIDEBAR -->
<aside class="sidebar" id="appSidebar" style="display:none">
  <div class="logo">
    <div class="logo-icon">üìä</div>
    <div class="logo-text">Mini<span>CRM</span></div>
  </div>
  <div class="nav-label">Menu</div>
  <div class="nav-item active" onclick="showPage('leads',this)"><span class="icon">üë•</span> Leads</div>
  <div class="nav-item" onclick="showPage('analytics',this)"><span class="icon">üìà</span> Analytics</div>
  <div class="nav-item" onclick="showPage('followups',this)"><span class="icon">üîî</span> Follow-ups</div>
  <div class="nav-item" onclick="showPage('settings',this)"><span class="icon">‚öôÔ∏è</span> Settings</div>
  <div class="sidebar-footer">
    <div class="admin-badge">
      <div class="admin-avatar">A</div>
      <div class="admin-info">
        <div class="admin-name" id="adminName">Admin</div>
        <div class="admin-role">Super Admin</div>
      </div>
    </div>
    <button class="logout-btn" onclick="doLogout()">üö™ Logout</button>
  </div>
</aside>

<!-- MAIN -->
<main class="main" id="appMain" style="display:none">

  <!-- LEADS -->
  <div class="page active" id="page-leads">
    <div class="header">
      <div><div class="header-title">Client <span>Leads</span></div><div class="header-sub">Manage and track your sales pipeline</div></div>
      <button class="btn btn-primary" onclick="openAddModal()">Ôºã Add Lead</button>
    </div>
    <div class="stats">
      <div class="stat-card"><div class="stat-label">TOTAL LEADS</div><div class="stat-value" id="stat-total">0</div><div class="stat-icon">üìã</div></div>
      <div class="stat-card"><div class="stat-label">NEW</div><div class="stat-value" id="stat-new">0</div><div class="stat-icon">üÜï</div></div>
      <div class="stat-card"><div class="stat-label">CONTACTED</div><div class="stat-value" id="stat-contacted">0</div><div class="stat-icon">üìû</div></div>
      <div class="stat-card"><div class="stat-label">CONVERTED</div><div class="stat-value" id="stat-converted">0</div><div class="stat-icon">‚úÖ</div></div>
    </div>
    <div class="toolbar">
      <div class="search-box"><span class="search-icon">üîç</span><input type="text" id="searchInput" placeholder="Search leads..." oninput="filterLeads()"/></div>
      <select class="filter-select" id="statusFilter" onchange="filterLeads()">
        <option value="">All Status</option><option value="new">New</option><option value="contacted">Contacted</option><option value="converted">Converted</option>
      </select>
    </div>
    <div class="table-wrapper">
      <table>
        <thead><tr><th>Lead</th><th>Source</th><th>Status</th><th>Notes</th><th>Date</th><th>Actions</th></tr></thead>
        <tbody id="leadsTable"><tr><td colspan="6"><div class="loading"><div class="spinner"></div>Loading leads...</div></td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- ANALYTICS -->
  <div class="page" id="page-analytics">
    <div class="header"><div><div class="header-title">üìà <span>Analytics</span></div><div class="header-sub">Pipeline performance insights</div></div></div>
    <div class="insight-grid">
      <div class="insight-card"><div class="insight-value" id="a-total">0</div><div class="insight-label">Total Leads</div></div>
      <div class="insight-card"><div class="insight-value" id="a-rate" style="color:var(--converted)">0%</div><div class="insight-label">Conversion Rate</div></div>
      <div class="insight-card"><div class="insight-value" id="a-week" style="color:var(--contacted)">0</div><div class="insight-label">Added This Week</div></div>
    </div>
    <div class="analytics-grid">
      <div class="chart-card">
        <div class="chart-title">Status <span>Breakdown</span></div>
        <div class="bar-chart">
          <div class="bar-row"><span class="bar-label">New</span><div class="bar-track"><div class="bar-fill bar-new" id="bar-new" style="width:0%">0</div></div></div>
          <div class="bar-row"><span class="bar-label">Contacted</span><div class="bar-track"><div class="bar-fill bar-contacted" id="bar-contacted" style="width:0%">0</div></div></div>
          <div class="bar-row"><span class="bar-label">Converted</span><div class="bar-track"><div class="bar-fill bar-converted" id="bar-converted" style="width:0%">0</div></div></div>
        </div>
      </div>
      <div class="chart-card">
        <div class="chart-title">Pipeline <span>Distribution</span></div>
        <div class="donut-wrap">
          <svg width="140" height="140" viewBox="0 0 140 140">
            <circle cx="70" cy="70" r="54" fill="none" stroke="#1a1a24" stroke-width="22"/>
            <circle id="donut-new" cx="70" cy="70" r="54" fill="none" stroke="#6c63ff" stroke-width="22" stroke-dasharray="339" stroke-dashoffset="339" transform="rotate(-90 70 70)" style="transition:stroke-dashoffset 1s ease"/>
            <circle id="donut-contacted" cx="70" cy="70" r="54" fill="none" stroke="#f7a51e" stroke-width="22" stroke-dasharray="339" stroke-dashoffset="339" transform="rotate(-90 70 70)" style="transition:stroke-dashoffset 1s ease"/>
            <circle id="donut-converted" cx="70" cy="70" r="54" fill="none" stroke="#43e97b" stroke-width="22" stroke-dasharray="339" stroke-dashoffset="339" transform="rotate(-90 70 70)" style="transition:stroke-dashoffset 1s ease"/>
            <text x="70" y="66" text-anchor="middle" fill="#e8e8f0" font-size="22" font-weight="800" font-family="Syne,sans-serif" id="donut-center">0</text>
            <text x="70" y="82" text-anchor="middle" fill="#6b6b80" font-size="11" font-family="DM Sans,sans-serif">Total</text>
          </svg>
          <div class="donut-legend">
            <div class="legend-item"><div class="legend-dot" style="background:#6c63ff"></div>New (<span id="leg-new">0</span>)</div>
            <div class="legend-item"><div class="legend-dot" style="background:#f7a51e"></div>Contacted (<span id="leg-contacted">0</span>)</div>
            <div class="legend-item"><div class="legend-dot" style="background:#43e97b"></div>Converted (<span id="leg-converted">0</span>)</div>
          </div>
        </div>
      </div>
      <div class="chart-card"><div class="chart-title">Leads by <span>Source</span></div><div id="sourceChart"><div style="color:var(--text-muted);text-align:center;padding:30px">No data yet</div></div></div>
      <div class="chart-card"><div class="chart-title">Pipeline <span>Health</span></div><div id="healthChart"><div style="color:var(--text-muted);text-align:center;padding:30px">No data yet</div></div></div>
    </div>
  </div>

  <!-- FOLLOW UPS -->
  <div class="page" id="page-followups">
    <div class="header">
      <div><div class="header-title">üîî <span>Follow-ups</span></div><div class="header-sub">Track and manage your follow-up tasks</div></div>
      <button class="btn btn-primary" onclick="openFollowupModal()">Ôºã Add Follow-up</button>
    </div>
    <div class="filter-tabs">
      <div class="filter-tab active" onclick="filterFollowups('all',this)">All</div>
      <div class="filter-tab" onclick="filterFollowups('overdue',this)">üî¥ Overdue</div>
      <div class="filter-tab" onclick="filterFollowups('today',this)">üü° Today</div>
      <div class="filter-tab" onclick="filterFollowups('upcoming',this)">üîµ Upcoming</div>
      <div class="filter-tab" onclick="filterFollowups('done',this)">‚úÖ Done</div>
    </div>
    <div class="followup-list" id="followupList"></div>
  </div>

  <!-- SETTINGS -->
  <div class="page" id="page-settings">
    <div class="header"><div><div class="header-title">‚öôÔ∏è <span>Settings</span></div><div class="header-sub">Manage your account and preferences</div></div></div>
    <div class="settings-grid">
      <div class="settings-card">
        <div class="settings-section-title">üë§ Profile</div>
        <div class="profile-section">
          <div class="profile-avatar-big">A</div>
          <div><div style="font-weight:600;font-size:16px" id="profileName">Admin User</div><div style="color:var(--text-muted);font-size:13px">Super Administrator</div></div>
        </div>
        <div class="form-group"><label class="form-label">Display Name</label><input type="text" class="form-input" id="settingName" value="Admin User"/></div>
        <div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="settingEmail" value="admin@minicrm.com"/></div>
        <div class="form-group"><label class="form-label">New Password</label><input type="password" class="form-input" placeholder="Leave blank to keep current"/></div>
        <button class="save-btn" onclick="saveProfile()">Save Profile</button>
      </div>
      <div class="settings-card">
        <div class="settings-section-title">üîî Notifications</div>
        <div class="settings-row"><div><div class="settings-label">Email Notifications</div><div class="settings-desc">Get alerts for new leads</div></div><label class="toggle"><input type="checkbox" checked/><span class="toggle-slider"></span></label></div>
        <div class="settings-row"><div><div class="settings-label">Follow-up Reminders</div><div class="settings-desc">Daily reminder for pending tasks</div></div><label class="toggle"><input type="checkbox" checked/><span class="toggle-slider"></span></label></div>
        <div class="settings-row"><div><div class="settings-label">Lead Converted Alert</div><div class="settings-desc">Notify when a lead converts</div></div><label class="toggle"><input type="checkbox"/><span class="toggle-slider"></span></label></div>
        <div class="settings-row"><div><div class="settings-label">Weekly Report</div><div class="settings-desc">Summary email every Monday</div></div><label class="toggle"><input type="checkbox" checked/><span class="toggle-slider"></span></label></div>
        <button class="save-btn" onclick="saveSettings()">Save Notifications</button>
      </div>
      <div class="settings-card">
        <div class="settings-section-title">üé® Preferences</div>
        <div class="settings-row"><div><div class="settings-label">Default Lead Source</div></div><select class="filter-select" style="padding:8px 12px;font-size:13px"><option>Website</option><option>Facebook</option><option>LinkedIn</option><option>Referral</option></select></div>
        <div class="settings-row"><div><div class="settings-label">Leads Per Page</div></div><input type="number" class="settings-input" value="20" min="5" max="100"/></div>
        <div class="settings-row"><div><div class="settings-label">Date Format</div></div><select class="filter-select" style="padding:8px 12px;font-size:13px"><option>DD MMM YYYY</option><option>MM/DD/YYYY</option><option>YYYY-MM-DD</option></select></div>
        <button class="save-btn" onclick="saveSettings()">Save Preferences</button>
      </div>
      <div class="settings-card">
        <div class="settings-section-title">üîå System</div>
        <div class="settings-row"><div><div class="settings-label">Backend URL</div></div></div>
        <input type="text" class="form-input" value="http://localhost:5000" style="margin-bottom:16px"/>
        <div class="settings-row"><div><div class="settings-label">Auto-refresh</div><div class="settings-desc">Refresh leads every 30s</div></div><label class="toggle"><input type="checkbox" id="tog-refresh" onchange="toggleAutoRefresh(this)"/><span class="toggle-slider"></span></label></div>
        <div class="settings-row"><div><div class="settings-label">Export Leads</div><div class="settings-desc">Download as CSV file</div></div><button class="action-btn action-edit" onclick="exportCSV()" style="padding:8px 14px">üì• Export CSV</button></div>
        <div class="settings-row"><div><div class="settings-label">Database Status</div></div><span id="dbStatus" class="status-badge status-new">Checking...</span></div>
      </div>
    </div>
  </div>

</main>

<!-- LEAD MODAL -->
<div class="modal-overlay" id="leadModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal()">‚úï</button>
    <div class="modal-title" id="modalTitle">Add New Lead</div>
    <input type="hidden" id="editId"/>
    <div class="form-group"><label class="form-label">Full Name *</label><input type="text" class="form-input" id="leadName" placeholder="John Smith"/></div>
    <div class="form-group"><label class="form-label">Email Address *</label><input type="email" class="form-input" id="leadEmail" placeholder="john@example.com"/></div>
    <div class="form-group"><label class="form-label">Source</label><select class="form-select" id="leadSource"><option value="Website">Website</option><option value="Facebook">Facebook</option><option value="LinkedIn">LinkedIn</option><option value="Referral">Referral</option><option value="Cold Call">Cold Call</option><option value="Other">Other</option></select></div>
    <div class="form-group"><label class="form-label">Status</label><select class="form-select" id="leadStatus"><option value="new">New</option><option value="contacted">Contacted</option><option value="converted">Converted</option></select></div>
    <div class="form-group"><label class="form-label">Notes / Follow-up</label><textarea class="form-textarea" id="leadNotes" placeholder="Add notes or follow-up details..."></textarea></div>
    <div class="modal-actions">
      <button class="btn btn-primary" onclick="saveLead()" style="flex:1">Save Lead</button>
      <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- FOLLOWUP MODAL -->
<div class="modal-overlay" id="followupModal">
  <div class="modal">
    <button class="modal-close" onclick="closeFollowupModal()">‚úï</button>
    <div class="modal-title">Add Follow-up Task</div>
    <div class="form-group"><label class="form-label">Lead Name *</label><input type="text" class="form-input" id="fuName" placeholder="e.g. John Smith"/></div>
    <div class="form-group"><label class="form-label">Task / Note *</label><textarea class="form-textarea" id="fuNote" placeholder="What do you need to follow up on?"></textarea></div>
    <div class="form-group"><label class="form-label">Due Date *</label><input type="date" class="form-input" id="fuDate"/></div>
    <div class="form-group"><label class="form-label">Priority</label><select class="form-select" id="fuPriority"><option value="upcoming">Normal</option><option value="today">High (Today)</option><option value="overdue">Urgent</option></select></div>
    <div class="modal-actions">
      <button class="btn btn-primary" onclick="saveFollowup()" style="flex:1">Add Follow-up</button>
      <button class="btn btn-ghost" onclick="closeFollowupModal()">Cancel</button>
    </div>
  </div>
</div>

<div class="notification" id="notification"></div>

<script>
  const API = 'http://localhost:5000/api/leads';
  let allLeads = [];
  let followups = [];
  let refreshTimer = null;

  // Load followups from memory
  try { followups = JSON.parse(localStorage.getItem('crm_followups') || '[]'); } catch(e) { followups = []; }

  // ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const USERS = { admin: 'admin123', manager: 'manager123' };

  function doLogin() {
    const u = document.getElementById('loginUser').value.trim();
    const p = document.getElementById('loginPass').value.trim();
    if (USERS[u] && USERS[u] === p) {
      document.getElementById('loginPage').style.display = 'none';
      document.getElementById('appSidebar').style.display = 'flex';
      document.getElementById('appMain').style.display = 'block';
      document.getElementById('adminName').textContent = u.charAt(0).toUpperCase() + u.slice(1);
      document.getElementById('profileName').textContent = u.charAt(0).toUpperCase() + u.slice(1) + ' User';
      fetchLeads();
      renderFollowups('all');
      checkDBStatus();
    } else {
      document.getElementById('loginError').style.display = 'block';
    }
  }

  function doLogout() {
    if (refreshTimer) clearInterval(refreshTimer);
    document.getElementById('appSidebar').style.display = 'none';
    document.getElementById('appMain').style.display = 'none';
    document.getElementById('loginPage').style.display = 'flex';
    document.getElementById('loginPass').value = '';
    document.getElementById('loginError').style.display = 'none';
    showNotification('üëã Logged out successfully', 'success');
  }

  document.addEventListener('keydown', e => {
    if (e.key === 'Enter' && document.getElementById('loginPage').style.display !== 'none') doLogin();
  });

  // ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function showPage(name, el) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.getElementById('page-' + name).classList.add('active');
    el.classList.add('active');
    if (name === 'analytics') updateAnalytics();
    if (name === 'followups') renderFollowups('all');
  }

  // ‚îÄ‚îÄ LEADS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function fetchLeads() {
    try {
      const res = await fetch(API);
      allLeads = await res.json();
      updateStats(allLeads);
      renderTable(allLeads);
    } catch {
      document.getElementById('leadsTable').innerHTML = `<tr><td colspan="6"><div class="empty-state"><div class="empty-icon">‚ö†Ô∏è</div><div class="empty-title">Cannot connect to backend</div><div style="color:var(--text-muted);font-size:14px">Make sure your server is running: node index.js</div></div></td></tr>`;
    }
  }

  function updateStats(leads) {
    document.getElementById('stat-total').textContent = leads.length;
    document.getElementById('stat-new').textContent = leads.filter(l => l.status === 'new').length;
    document.getElementById('stat-contacted').textContent = leads.filter(l => l.status === 'contacted').length;
    document.getElementById('stat-converted').textContent = leads.filter(l => l.status === 'converted').length;
  }

  function renderTable(leads) {
    const tbody = document.getElementById('leadsTable');
    if (!leads.length) {
      tbody.innerHTML = `<tr><td colspan="6"><div class="empty-state"><div class="empty-icon">üì≠</div><div class="empty-title">No leads found</div><div style="color:var(--text-muted)">Click "Add Lead" to get started</div></div></td></tr>`;
      return;
    }
    tbody.innerHTML = leads.map(lead => `
      <tr>
        <td><div class="lead-name">${lead.name}</div><div class="lead-email">${lead.email}</div></td>
        <td><span class="source-badge">üåê ${lead.source||'Website'}</span></td>
        <td><span class="status-badge status-${lead.status}"><span class="status-dot"></span>${lead.status.charAt(0).toUpperCase()+lead.status.slice(1)}</span></td>
        <td style="max-width:180px;color:var(--text-muted);font-size:13px">${lead.notes ? lead.notes.substring(0,60)+(lead.notes.length>60?'‚Ä¶':'') : '‚Äî'}</td>
        <td style="color:var(--text-muted);font-size:13px">${new Date(lead.createdAt).toLocaleDateString('en-ZA',{day:'2-digit',month:'short',year:'numeric'})}</td>
        <td><div class="actions"><button class="action-btn action-edit" onclick='openEditModal(${JSON.stringify(lead)})'>Edit</button><button class="action-btn action-delete" onclick="deleteLead('${lead._id}')">Delete</button></div></td>
      </tr>`).join('');
  }

  function filterLeads() {
    const search = document.getElementById('searchInput').value.toLowerCase();
    const status = document.getElementById('statusFilter').value;
    renderTable(allLeads.filter(l =>
      (!search || l.name.toLowerCase().includes(search) || l.email.toLowerCase().includes(search)) &&
      (!status || l.status === status)
    ));
  }

  function openAddModal() {
    document.getElementById('modalTitle').textContent = 'Add New Lead';
    document.getElementById('editId').value = '';
    ['leadName','leadEmail','leadNotes'].forEach(id => document.getElementById(id).value = '');
    document.getElementById('leadSource').value = 'Website';
    document.getElementById('leadStatus').value = 'new';
    document.getElementById('leadModal').classList.add('open');
  }

  function openEditModal(lead) {
    document.getElementById('modalTitle').textContent = 'Edit Lead';
    document.getElementById('editId').value = lead._id;
    document.getElementById('leadName').value = lead.name;
    document.getElementById('leadEmail').value = lead.email;
    document.getElementById('leadSource').value = lead.source || 'Website';
    document.getElementById('leadStatus').value = lead.status;
    document.getElementById('leadNotes').value = lead.notes || '';
    document.getElementById('leadModal').classList.add('open');
  }

  function closeModal() { document.getElementById('leadModal').classList.remove('open'); }

  async function saveLead() {
    const id = document.getElementById('editId').value;
    const name = document.getElementById('leadName').value.trim();
    const email = document.getElementById('leadEmail').value.trim();
    const source = document.getElementById('leadSource').value;
    const status = document.getElementById('leadStatus').value;
    const notes = document.getElementById('leadNotes').value.trim();
    if (!name || !email) { showNotification('Name and email are required!', 'error'); return; }
    try {
      if (id) {
        await fetch(`${API}/${id}/status`, { method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify({status}) });
        await fetch(`${API}/${id}/notes`, { method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify({notes}) });
        showNotification('‚úÖ Lead updated!', 'success');
      } else {
        await fetch(API, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({name,email,source,status,notes}) });
        showNotification('‚úÖ Lead added!', 'success');
      }
      closeModal(); fetchLeads();
    } catch { showNotification('‚ùå Something went wrong!', 'error'); }
  }

  async function deleteLead(id) {
    if (!confirm('Delete this lead?')) return;
    try {
      await fetch(`${API}/${id}`, { method:'DELETE' });
      showNotification('üóëÔ∏è Lead deleted!', 'success');
      fetchLeads();
    } catch { showNotification('‚ùå Could not delete!', 'error'); }
  }

  // ‚îÄ‚îÄ ANALYTICS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function updateAnalytics() {
    const total = allLeads.length;
    const nNew = allLeads.filter(l => l.status==='new').length;
    const nCont = allLeads.filter(l => l.status==='contacted').length;
    const nConv = allLeads.filter(l => l.status==='converted').length;
    const rate = total ? Math.round((nConv/total)*100) : 0;
    const weekAgo = new Date(Date.now()-7*24*60*60*1000);
    const thisWeek = allLeads.filter(l => new Date(l.createdAt) > weekAgo).length;

    document.getElementById('a-total').textContent = total;
    document.getElementById('a-rate').textContent = rate + '%';
    document.getElementById('a-week').textContent = thisWeek;

    const max = Math.max(nNew, nCont, nConv, 1);
    document.getElementById('bar-new').style.width = Math.max(nNew/max*100,5)+'%';
    document.getElementById('bar-new').textContent = nNew;
    document.getElementById('bar-contacted').style.width = Math.max(nCont/max*100,5)+'%';
    document.getElementById('bar-contacted').textContent = nCont;
    document.getElementById('bar-converted').style.width = Math.max(nConv/max*100,5)+'%';
    document.getElementById('bar-converted').textContent = nConv;

    document.getElementById('donut-center').textContent = total;
    document.getElementById('leg-new').textContent = nNew;
    document.getElementById('leg-contacted').textContent = nCont;
    document.getElementById('leg-converted').textContent = nConv;

    if (total > 0) {
      const C = 339;
      const pN = nNew/total, pC = nCont/total, pV = nConv/total;
      document.getElementById('donut-new').setAttribute('stroke-dashoffset', C*(1-pN));
      document.getElementById('donut-contacted').style.strokeDashoffset = C*(1-pC);
      document.getElementById('donut-converted').style.strokeDashoffset = C*(1-pV);
    }

    const sources = {};
    allLeads.forEach(l => { const s = l.source||'Website'; sources[s]=(sources[s]||0)+1; });
    document.getElementById('sourceChart').innerHTML = Object.entries(sources).length
      ? Object.entries(sources).sort((a,b)=>b[1]-a[1]).map(([s,c])=>`
        <div class="source-row">
          <span>üåê ${s}</span>
          <div style="display:flex;align-items:center;gap:10px">
            <div style="width:80px;height:6px;background:var(--surface2);border-radius:3px"><div style="width:${Math.round(c/total*100)}%;height:100%;background:var(--accent);border-radius:3px"></div></div>
            <span style="color:var(--text-muted);font-size:13px">${c} (${Math.round(c/total*100)}%)</span>
          </div>
        </div>`).join('')
      : '<div style="color:var(--text-muted);text-align:center;padding:30px">No data yet</div>';

    const emoji = rate>=50?'üöÄ':rate>=25?'üìà':rate>=10?'‚ö†Ô∏è':'üìâ';
    const health = rate>=50?'üü¢ Excellent':rate>=25?'üü° Good':rate>=10?'üü† Needs Work':'üî¥ Poor';
    document.getElementById('healthChart').innerHTML = `
      <div style="text-align:center;padding:16px">
        <div style="font-size:48px;margin-bottom:12px">${emoji}</div>
        <div style="font-family:Syne,sans-serif;font-size:24px;font-weight:800;margin-bottom:8px">${health}</div>
        <div style="color:var(--text-muted);font-size:14px">Conversion rate: <strong style="color:var(--converted)">${rate}%</strong></div>
        <div style="margin-top:12px;color:var(--text-muted);font-size:13px">${total} total ¬∑ ${nConv} converted ¬∑ ${nNew+nCont} in pipeline</div>
      </div>`;
  }

  // ‚îÄ‚îÄ FOLLOW UPS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function saveFollowupsStorage() {
    try { localStorage.setItem('crm_followups', JSON.stringify(followups)); } catch(e) {}
  }

  function openFollowupModal() {
    document.getElementById('fuName').value = '';
    document.getElementById('fuNote').value = '';
    document.getElementById('fuDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('fuPriority').value = 'upcoming';
    document.getElementById('followupModal').classList.add('open');
  }

  function closeFollowupModal() { document.getElementById('followupModal').classList.remove('open'); }

  function saveFollowup() {
    const name = document.getElementById('fuName').value.trim();
    const note = document.getElementById('fuNote').value.trim();
    const date = document.getElementById('fuDate').value;
    if (!name || !note || !date) { showNotification('Please fill all fields!', 'error'); return; }
    followups.push({ id: Date.now(), name, note, date, done: false });
    saveFollowupsStorage();
    closeFollowupModal();
    renderFollowups('all');
    showNotification('‚úÖ Follow-up added!', 'success');
  }

  function renderFollowups(filter) {
    const today = new Date().toISOString().split('T')[0];
    let list = [...followups];
    if (filter === 'overdue') list = followups.filter(f => !f.done && f.date < today);
    else if (filter === 'today') list = followups.filter(f => !f.done && f.date === today);
    else if (filter === 'upcoming') list = followups.filter(f => !f.done && f.date > today);
    else if (filter === 'done') list = followups.filter(f => f.done);

    const container = document.getElementById('followupList');
    if (!list.length) {
      container.innerHTML = `<div style="text-align:center;padding:60px;color:var(--text-muted)"><div style="font-size:48px;margin-bottom:12px">üì≠</div><div style="font-family:Syne,sans-serif;font-size:18px;font-weight:700;color:var(--text);margin-bottom:8px">No follow-ups here</div><div>Click "+ Add Follow-up" to create one</div></div>`;
      return;
    }
    container.innerHTML = list.map(f => {
      const cls = f.done ? 'done' : f.date < today ? 'overdue' : f.date === today ? 'today' : 'upcoming';
      const dcls = f.date < today ? 'date-overdue' : f.date === today ? 'date-today' : 'date-upcoming';
      const initials = f.name.split(' ').map(w=>w[0]).join('').toUpperCase().substring(0,2);
      return `<div class="followup-card ${cls}">
        <div class="followup-avatar">${initials}</div>
        <div class="followup-info">
          <div class="followup-name">${f.name} ${f.done?'<span style="color:var(--converted);font-size:12px">‚úÖ Done</span>':''}</div>
          <div class="followup-note">${f.note}</div>
        </div>
        <span class="followup-date ${dcls}">${f.date}</span>
        <div class="followup-actions">
          ${!f.done?`<button class="action-btn action-edit" onclick="markDone(${f.id})">‚úÖ Done</button>`:''}
          <button class="action-btn action-delete" onclick="deleteFollowup(${f.id})">üóëÔ∏è</button>
        </div>
      </div>`;
    }).join('');
  }

  function filterFollowups(filter, el) {
    document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    renderFollowups(filter);
  }

  function markDone(id) {
    const f = followups.find(f => f.id === id);
    if (f) { f.done = true; saveFollowupsStorage(); renderFollowups('all'); showNotification('‚úÖ Marked as done!', 'success'); }
  }

  function deleteFollowup(id) {
    followups = followups.filter(f => f.id !== id);
    saveFollowupsStorage();
    renderFollowups('all');
    showNotification('üóëÔ∏è Follow-up deleted!', 'success');
  }

  // ‚îÄ‚îÄ SETTINGS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function saveProfile() {
    const name = document.getElementById('settingName').value;
    document.getElementById('profileName').textContent = name;
    document.getElementById('adminName').textContent = name;
    showNotification('‚úÖ Profile saved!', 'success');
  }

  function saveSettings() { showNotification('‚úÖ Settings saved!', 'success'); }

  function toggleAutoRefresh(el) {
    if (el.checked) { refreshTimer = setInterval(fetchLeads, 30000); showNotification('üîÑ Auto-refresh enabled', 'success'); }
    else { clearInterval(refreshTimer); showNotification('‚èπÔ∏è Auto-refresh disabled', 'success'); }
  }

  async function checkDBStatus() {
    try {
      await fetch(API);
      document.getElementById('dbStatus').textContent = 'üü¢ Connected';
      document.getElementById('dbStatus').className = 'status-badge status-converted';
    } catch {
      document.getElementById('dbStatus').textContent = 'üî¥ Offline';
      document.getElementById('dbStatus').className = 'status-badge status-new';
    }
  }

  function exportCSV() {
    if (!allLeads.length) { showNotification('No leads to export!', 'error'); return; }
    const rows = [['Name','Email','Source','Status','Notes','Created'], ...allLeads.map(l => [l.name, l.email, l.source||'Website', l.status, (l.notes||'').replace(/,/g,''), new Date(l.createdAt).toLocaleDateString()])];
    const csv = rows.map(r => r.join(',')).join('\n');
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
    a.download = 'leads-export.csv';
    a.click();
    showNotification('üì• CSV exported!', 'success');
  }

  // ‚îÄ‚îÄ NOTIFICATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function showNotification(msg, type='success') {
    const n = document.getElementById('notification');
    n.textContent = msg;
    n.className = `notification ${type} show`;
    setTimeout(() => n.classList.remove('show'), 3000);
  }

  // Close modals on backdrop click
  document.getElementById('leadModal').addEventListener('click', e => { if(e.target===document.getElementById('leadModal')) closeModal(); });
  document.getElementById('followupModal').addEventListener('click', e => { if(e.target===document.getElementById('followupModal')) closeFollowupModal(); });

  // Seed default followups if empty
  if (!followups.length) {
    const today = new Date().toISOString().split('T')[0];
    const yesterday = new Date(Date.now()-86400000).toISOString().split('T')[0];
    const tomorrow = new Date(Date.now()+86400000).toISOString().split('T')[0];
    followups = [
      { id:1, name:'John Smith', note:'Send proposal for premium package. Client very interested.', date:yesterday, done:false },
      { id:2, name:'Sarah Johnson', note:'Follow up on demo call. Schedule meeting for next steps.', date:today, done:false },
      { id:3, name:'Mike Dlamini', note:'Onboarding call scheduled. Send welcome email first.', date:tomorrow, done:false },
    ];
    saveFollowupsStorage();
  }
</script>
</body>
</html>